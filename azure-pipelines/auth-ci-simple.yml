# CI Pipeline for Auth Service (Simplified - No Variable Groups Required)
# Purpose: Build, test, and push Docker image to ACR
# Use this version if variable groups are not set up yet

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - auth-service/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  # UPDATE THESE VALUES with your actual resource names
  - name: serviceName
    value: 'auth-service'
  - name: acrName
    value: '<YOUR_ACR_NAME>'  # e.g., 'ecomacr12345'
  - name: dockerfilePath
    value: 'auth-service/Dockerfile'
  - name: imageTag
    value: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: 'Build and Test'
  jobs:
  - job: BuildJob
    displayName: 'Build .NET Application'
    steps:
    - task: UseDotNet@2
      displayName: 'Use .NET 8.0 SDK'
      inputs:
        packageType: 'sdk'
        version: '8.0.x'
    
    - task: DotNetCoreCLI@2
      displayName: 'Restore NuGet packages'
      inputs:
        command: 'restore'
        projects: '**/*.csproj'
      continueOnError: true
    
    - task: DotNetCoreCLI@2
      displayName: 'Build solution'
      inputs:
        command: 'build'
        projects: '**/*.csproj'
        arguments: '--configuration Release --no-restore'
      continueOnError: true
    
    - task: DotNetCoreCLI@2
      displayName: 'Run unit tests'
      inputs:
        command: 'test'
        projects: '**/*.csproj'
        arguments: '--configuration Release --no-build --collect:"XPlat Code Coverage"'
      continueOnError: true

- stage: Docker
  displayName: 'Build and Push Docker Image'
  dependsOn: Build
  condition: succeededOrFailed()  # Continue even if tests fail
  jobs:
  - job: DockerJob
    displayName: 'Docker Build and Push'
    steps:
    - task: Docker@2
      displayName: 'Login to ACR'
      inputs:
        command: 'login'
        containerRegistry: 'ACR-Connection'  # Create this service connection first
    
    - task: Docker@2
      displayName: 'Build Docker image'
      inputs:
        command: 'build'
        repository: '$(serviceName)'
        dockerfile: '$(dockerfilePath)'
        containerRegistry: 'ACR-Connection'
        tags: |
          $(imageTag)
          latest
    
    - task: Docker@2
      displayName: 'Push Docker image'
      inputs:
        command: 'push'
        repository: '$(serviceName)'
        containerRegistry: 'ACR-Connection'
        tags: |
          $(imageTag)
          latest

